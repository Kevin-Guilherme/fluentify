generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  FLUENT
}

enum ConversationStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model User {
  id            String    @id @default(uuid())
  supabaseId    String    @unique @map("supabase_id")
  email         String    @unique
  name          String
  avatarUrl     String?   @map("avatar_url")
  level         UserLevel @default(BEGINNER)
  xp            Int       @default(0)
  streak        Int       @default(0)
  lastActiveAt  DateTime? @map("last_active_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  conversations Conversation[]
  achievements  UserAchievement[]

  @@map("users")
}

model Topic {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  description String
  emoji       String
  difficulty  UserLevel @default(BEGINNER)
  category    String
  systemPrompt String  @map("system_prompt") @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  conversations Conversation[]

  @@map("topics")
}

model Conversation {
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  topicId   String             @map("topic_id")
  status    ConversationStatus @default(ACTIVE)
  score     Int?
  xpEarned  Int?               @map("xp_earned")
  duration  Int?
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic     Topic              @relation(fields: [topicId], references: [id])
  messages  Message[]
  feedback  ConversationFeedback?

  @@map("conversations")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String      @db.Text
  audioUrl       String?     @map("audio_url")
  duration       Int?
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model ConversationFeedback {
  id              String   @id @default(uuid())
  conversationId  String   @unique @map("conversation_id")
  grammarScore    Int      @map("grammar_score")
  vocabularyScore Int      @map("vocabulary_score")
  fluencyScore    Int      @map("fluency_score")
  overallScore    Int      @map("overall_score")
  grammarErrors   Json     @map("grammar_errors")
  suggestions     Json
  strengths       Json
  createdAt       DateTime @default(now()) @map("created_at")

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("conversation_feedbacks")
}

model UserAchievement {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String
  metadata    Json?
  unlockedAt  DateTime @default(now()) @map("unlocked_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("user_achievements")
}
